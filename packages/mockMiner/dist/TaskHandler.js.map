{"version":3,"sources":["../src/TaskHandler.js"],"names":["NUM_MINERS","SLEEP_BETWEEN_CHECKS","MINER_ADDRESSES","sleep","Promise","done","setTimeout","time","TaskHandler","props","chain","miners","initRequired","miningSleepTime","i","m","Miner","account","push","forEach","fn","bind","console","log","running","contract","tellorPostConstructor","getCurrentVariables","next","_challenge","_runMiningCycle","all","canMine","length","getStakerInfo","stat","status","mine","challenge","queryString","_queryString","difficulty","_difficulty","nonces","n","_getValue","value","isNaN","Math","ceil","_granularity","_submitNonce","miner","nonce","jsonFields","startsWith","fields","substr","lastIndexOf","s","substring","indexOf","split","axios","get","r","data","JSON","parse","finalVal","d","f","trim","price","submitMiningSolution","_requestId"],"mappings":"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","file":"TaskHandler.js","sourcesContent":["import Miner from './Miner';\nimport axios from 'axios';\n\nconst NUM_MINERS = 6;\nconst SLEEP_BETWEEN_CHECKS = 15000;\n//const SLEEP_BETWEEN_MINES = 65000; //10000;\n\nconst MINER_ADDRESSES = [\n                         \"0xe010aC6e0248790e08F42d5F697160DEDf97E024\",\n                         \"0xE037EC8EC9ec423826750853899394dE7F024fee\",\n                         \"0xcdd8FA31AF8475574B8909F135d510579a8087d3\",\n                         \"0xb9dD5AfD86547Df817DA2d0Fb89334A6F8eDd891\",\n                         \"0x230570cD052f40E14C14a81038c6f3aa685d712B\",\n                         \"0x3233afA02644CCd048587F8ba6e99b3C00A34DcC\"\n                       ];\n\nconst sleep = time => {\n  return new Promise((done)=> {\n    setTimeout(done, time);\n  });\n}\n\nexport default class TaskHandler {\n  constructor(props) {\n    this.chain = props.chain;\n    this.miners = [];\n    this.initRequired = props.initRequired;\n    this.miningSleepTime = props.miningSleepTime;\n\n    for(let i=0;i<NUM_MINERS;++i) {\n      let m = new Miner({\n        chain: this.chain,\n        account: MINER_ADDRESSES[i]\n      });\n      this.miners.push(m);\n    }\n    [\n      'start',\n      'stop',\n      '_runMiningCycle',\n      '_submitNonce',\n      '_getValue'\n    ].forEach(fn=>this[fn]=this[fn].bind(this));\n  }\n\n  async start() {\n    console.log(\"Mining tasker starting up\");\n    this.running = true;\n    if(this.initRequired) {\n      await this.chain.contract.tellorPostConstructor(MINER_ADDRESSES[0]);\n      console.log(\"Contract initialized\");\n    }\n    while(this.running) {\n      try {\n        let next = await this.chain.contract.getCurrentVariables();\n\n        if(next._challenge) {\n          console.log(\"New challenge to be mined: \", next)\n          await this._runMiningCycle(next);\n          console.log(\"Waiting for next mining cycle...\");\n          await sleep(this.miningSleepTime);\n        } else {\n          console.log(\"Waiting to check for new tasking...\");\n          await sleep(SLEEP_BETWEEN_CHECKS);\n        }\n      } catch (e) {\n        console.log(\"Problem in task run loop\", e);\n      }\n    }\n    console.log(\"Mining tasker shutting down\");\n  }\n\n  async stop() {\n    this.running = false;\n  }\n\n  async _runMiningCycle(next) {\n\n    let all = [];\n    let canMine = [];\n    for(let i=0;i<this.miners.length;++i) {\n      let m = this.miners[i];\n      let stat = await this.chain.contract.getStakerInfo(m.account);\n      console.log(\"Address, Status\", m.account, stat);\n      if(stat.status === 1 && canMine.length < 5) {\n        canMine.push(m);\n      }\n    }\n    if(canMine.length < 5) {\n      console.log(\"Don't have enough mock miners to run mining cycle!\");\n      return;\n    }\n\n    canMine.forEach(m=>{\n      all.push(m.mine({\n      challenge: next._challenge,\n      queryString: next._queryString,\n      difficulty: next._difficulty\n    }))});\n    let nonces = await Promise.all(all);\n    for(let i=0;i<nonces.length;++i) {\n      let n = nonces[i];\n      if(n > 0) {\n        let value = await this._getValue(next._queryString);\n        if(!isNaN(value)) {\n          value = Math.ceil(value * next._granularity);\n          await this._submitNonce({...next, miner: canMine[i].account, nonce: n, value});\n        }\n      }\n    }\n  }\n\n  async _getValue(queryString) {\n    let jsonFields = null;\n    if(queryString.startsWith(\"json\")) {\n      let fields = queryString.substr(queryString.lastIndexOf(\")\")+1);\n      let s = queryString.substring(queryString.indexOf(\"(\")+1, queryString.lastIndexOf(\")\"));\n      queryString = s;\n      jsonFields = fields.split(\".\");\n    }\n    //console.log(\"Will query value\", queryString, jsonField);\n    let r = await axios.get(queryString);\n    let data = r.data;\n    if(typeof data === 'string') {\n      data = JSON.parse(data);\n    }\n    if(jsonFields) {\n      let finalVal = null;\n      let d = data;\n      jsonFields.forEach(f=>{\n        if(f.trim().length > 0) {\n          d = d[f];\n        }\n      });\n      return d-0;\n    }\n    if(isNaN(data)) {\n      if(data.price) {\n        return data.price - 0;\n      }\n      return 0;\n    }\n    return data-0;\n  }\n\n  async _submitNonce(props) {\n    try {\n      console.log(\"Submitting solution\", props);\n      await this.chain.contract.submitMiningSolution(props.miner, \"\"+props.nonce, props._requestId, props.value);\n      console.log(\"Submitted mining solution\", props);\n    } catch (e) {\n      console.log(\"Failed to submit mining solution\", e);\n    }\n  }\n}\n"]}